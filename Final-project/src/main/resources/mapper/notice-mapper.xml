<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="noticeMapper">
	
	<resultMap id="noticeResultSet" type="notice">
		<result column="NOTICE_NO" property="noticeNo" />
		<result column="NOTICE_TITLE" property="noticeTitle" />
		<result column="NOTICE_CONTENT" property="noticeContent" />
		<result column="VIEWS" property="views" />
		<result column="NOTICE_CREATE_DATE" property="noticeCreateDate" />
		<result column="CATEGORY" property="category" />
		<result column="LIKE_COUNT" property="likeCount" />
		<result column="MEM_NICK" property="memNo" />
	</resultMap>	
	
	<select id="selectNoticeCount" resultType="_int">
		SELECT
		      COUNT(*)
		  FROM
		      TB_NOTICE
		 WHERE
		      STATUS = 'Y' 
	</select>
	
	<select id="selectNoticeList" resultMap="noticeResultSet">
			SELECT
			      NOTICE_NO
			     ,NOTICE_TITLE
			     ,NOTICE_CONTENT
			     ,VIEWS
			     ,TO_CHAR(NOTICE_CREATE_DATE, 'YYYY-MM-DD') AS "NOTICE_CREATE_DATE"
			     ,CATEGORY
			     ,LIKE_COUNT
			     ,MEM_NICK
			 FROM
			     TB_NOTICE
			INNER
			 JOIN
			     MEMBER ON(TB_NOTICE.MEM_NO = MEMBER.MEM_NO)
			WHERE
			     STATUS='Y'
			ORDER
			   BY
			     CATEGORY DESC, NOTICE_NO DESC
	</select>
	<select id="selectBestNotice" resultMap="noticeResultSet">
          SELECT 
			    *
			FROM
			  (SELECT
			    NOTICE_NO,
			    NOTICE_TITLE,
			    NOTICE_CONTENT,
			    VIEWS,
			    TO_CHAR(NOTICE_CREATE_DATE, 'YYYY-MM-DD') AS "NOTICE_CREATE_DATE",
			    CATEGORY,
			    LIKE_COUNT,
			    MEM_NICK
			FROM
			    TB_NOTICE
	  INNER JOIN
			    MEMBER ON (TB_NOTICE.MEM_NO = MEMBER.MEM_NO)
		   WHERE
			    STATUS = 'Y'
			 AND 
			    CATEGORY = 2
			 AND
			    LIKE_COUNT &gt; 50
		ORDER BY
			    LIKE_COUNT DESC, NOTICE_NO DESC) b
	       WHERE 
	            ROWNUM BETWEEN 1 AND 5

	   UNION ALL
		  SELECT
		         *
			FROM(
		         SELECT
					    NOTICE_NO,
					    NOTICE_TITLE,
					    NOTICE_CONTENT,
					    VIEWS,
					    TO_CHAR(NOTICE_CREATE_DATE, 'YYYY-MM-DD') AS "NOTICE_CREATE_DATE",
					    CATEGORY,
					    LIKE_COUNT,
					    MEM_NICK
				   FROM
			            TB_NOTICE
		     INNER JOIN
			            MEMBER ON (TB_NOTICE.MEM_NO = MEMBER.MEM_NO)
			      WHERE
			            STATUS = 'Y'
			        AND 
			            LIKE_COUNT &gt; 50
			        AND   
			            CATEGORY = 1
			   ORDER BY
			            LIKE_COUNT DESC, NOTICE_NO DESC
			      ) 
			 WHERE 

				  ROWNUM BETWEEN 1 AND 5
	</select> 
	<insert id="insertNotice" parameterType="notice">
		INSERT
		  INTO
		      TB_NOTICE
		      (
			  NOTICE_NO
			 ,NOTICE_TITLE
			 ,NOTICE_CONTENT
			 ,MEM_NO
			 ,CATEGORY
			 )
	   VALUES		  
	   	     (
	   	     SEQ_NOTICE_NO.NEXTVAL
	   	    ,#{noticeTitle}
	   	    ,#{noticeContent}
	   	    ,#{memNo}
	   	    ,#{category}
	   	     )
	</insert>
	
	<insert id="insertFile" parameterType="files">
		INSERT
		  INTO
		      TB_FILES
		      (
		      FILE_NO
		     ,REF_NO
		     ,ORIGINAL_NAME
		     ,UPDATE_NAME
		     ,FILE_PATH
		     ,REF_TYPE
		     ,FILE_ANNOTATION
		      )
		VALUES
		      (
		      SEQ_FILE_NO.NEXTVAL
		     ,#{refNo}
		     ,#{originalName}
		     ,#{updateName}
		     ,#{filePath}
		     ,#{refType}
		     ,#{fileAnnotation}
		      )
	</insert>
	
 	<update id="increaseCount" parameterType="_int">
 		UPDATE
 		      TB_NOTICE
 		   SET
 		      VIEWS = VIEWS + 1
 		 WHERE
 		      NOTICE_NO = #{noticeNo}
 		   AND
 		      STATUS = 'Y'
 	</update>
 
 	<select id="selectNotice" parameterType="_int" resultMap="noticeResultSet">
			SELECT
			      NOTICE_NO
			     ,NOTICE_TITLE
			     ,NOTICE_CONTENT
			     ,VIEWS
			     ,TO_CHAR(NOTICE_CREATE_DATE, 'YYYY-MM-DD HH:MI:SS') AS "NOTICE_CREATE_DATE"
			     ,CATEGORY
			     ,LIKE_COUNT
			     ,MEM_NICK
			 FROM
			     TB_NOTICE
			INNER
			 JOIN
			     MEMBER ON(TB_NOTICE.MEM_NO = MEMBER.MEM_NO)
			WHERE
			     STATUS='Y'
			  AND
			     NOTICE_NO = #{noticeNo}
 	</select>
 	
 	<update id="deleteNotice" parameterType="_int">
 		UPDATE
 		      TB_NOTICE
 		   SET
 		      STATUS = 'N'
 		 WHERE
 		      NOTICE_NO = #{noticeNo}
 	</update>
	
	<update id="updateNotice" parameterType="notice">
		UPDATE
		      TB_NOTICE
		   SET
		      NOTICE_TITLE = #{noticeTitle}
		     ,NOTICE_CONTENT = #{noticeContent}
		 WHERE
		      NOTICE_NO = #{noticeNo}
	</update>

	<select id="selectLastNoticeNo" resultType="_int">
		SELECT 
			  MAX(NOTICE_NO)
		  FROM
		      TB_NOTICE
	</select>
	
	<select id="selectFile" resultType="files">
		SELECT
		      FILE_NO fileNo
		     ,ORIGINAL_NAME originalName
		     ,UPDATE_NAME updateName
		     ,FILE_PATH filePath
		     ,REF_TYPE refType
		     ,REF_NO refNo
		     ,FILE_ANNOTATION fileAnnotation
		     ,UPLOAD_DATE uploadDate
		 FROM
		     TB_FILES
	    WHERE
	         REF_NO = #{noticeNo}
	      AND
	         REF_TYPE = 'notice'
		      
	</select>

	<update id="updateFiles" parameterType="files">
		UPDATE
		      TB_FILES
		   SET
		      ORIGINAL_NAME = #{originalName}
		     ,UPDATE_NAME = #{updateName}
		     ,FILE_ANNOTATION = #{fileAnnotation}
		 WHERE
		      FILE_NO = #{fileNo}
	</update>
</mapper>

